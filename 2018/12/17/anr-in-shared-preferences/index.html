<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> ANR in SharedPreferences · ZG's Blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="ANR in SharedPreferences - Zhicheng Gu"><meta name="keywords"><meta name="author" content="Zhicheng Gu"><link rel="short icon" href="/images/logo.jpeg"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="http://zcgu.github.io/atom.xml" title="ZG's Blog"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.jpeg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="POSTS" class="nav-list-link">POSTS</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="ARCHIVES" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/about/" target="_self" data-hover="ABOUT" class="nav-list-link">ABOUT</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">ANR in SharedPreferences</h1><div class="post-info">2018-12-17<p class="visit"><i data-hk-page="current">-</i><span>visits</span></p></div><div class="post-content"><h2 id="The-Issue"><a href="#The-Issue" class="headerlink" title="The Issue"></a>The Issue</h2><p>When using SharedPreference you will probably see the following ANRs:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">at java.lang.Object.wait(Native Method)</span><br><span class="line">- waiting on &lt;&gt;</span><br><span class="line">at java.lang.Thread.parkFor(Thread.java:)</span><br><span class="line">at sun.misc.Unsafe.park(Unsafe.java:)</span><br><span class="line">at java.util.concurrent.locks.LockSupport.park(LockSupport.java:157)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:813)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:973)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1281)</span><br><span class="line">at java.util.concurrent.CountDownLatch.await(CountDownLatch.java:202)</span><br><span class="line">at android.app.SharedPreferencesImpl$EditorImpl.run(SharedPreferencesImpl.java:363)</span><br><span class="line">at android.app.QueuedWork.waitToFinish(QueuedWork.java:88)</span><br><span class="line">at android.app.ActivityThread.handleStopActivity(ActivityThread.java:3948)</span><br><span class="line">at android.app.ActivityThread.access$1100(ActivityThread.java:)</span><br></pre></td></tr></table></figure>
<p>We can see that main thread is blocking by <code>ActivityThread.handleStopActivity</code> -&gt; <code>QueuedWork.waitToFinish</code> -&gt; <code>SharedPreferencesImpl$EditorImpl.run</code>. By looking at the source code for SharedPreference you will find that the <code>QueueWork</code> is an internal queue used by SharedPreference write operations like <code>apply()</code>. At some points in the app, main thread will wait for all queued write to be done.</p>
<a id="more"></a>
<p>If the IO on the device is slow enough or there is some work blocking IO, the above ANR will happen. One example of slow IO work is fsync as shown in this <a href="https://stackoverflow.com/questions/36905415/how-to-analyze-anr-in-sharedpreferences" target="_blank" rel="noopener">StackOverflow thread</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&quot;pool-1-thread-1&quot; prio=5 tid=10 SUSPENDED</span><br><span class="line">| group=&quot;main&quot; sCount=1 dsCount=0 obj=0x41ca62e0 self=0x6034b008</span><br><span class="line">| sysTid=4246 nice=0 sched=0/0 cgrp=apps handle=1612996584</span><br><span class="line">| state=S schedstat=( 189967314 218846863 555 ) utm=15 stm=3 core=2</span><br><span class="line">#00  pc 00021af0  /system/lib/libc.so (__futex_syscall3+8)</span><br><span class="line">#01  pc 0000f0b4  /system/lib/libc.so (__pthread_cond_timedwait_relative+48)</span><br><span class="line">#02  pc 0000f114  /system/lib/libc.so (__pthread_cond_timedwait+64)</span><br><span class="line">#03  pc 000566e7  /system/lib/libdvm.so</span><br><span class="line">#04  pc 00056ca9  /system/lib/libdvm.so (dvmChangeStatus(Thread*, ThreadStatus)+34)</span><br><span class="line">#05  pc 0005115f  /system/lib/libdvm.so (dvmCallJNIMethod(unsigned int const*, JValue*, Method const*, Thread*)+406)</span><br><span class="line">#06  pc 00029960  /system/lib/libdvm.so</span><br><span class="line">#07  pc 00030dec  /system/lib/libdvm.so (dvmMterpStd(Thread*)+76)</span><br><span class="line">#08  pc 0002e484  /system/lib/libdvm.so (dvmInterpret(Thread*, Method const*, JValue*)+184)</span><br><span class="line">#09  pc 000635b9  /system/lib/libdvm.so (dvmCallMethodV(Thread*, Method const*, Object*, bool, JValue*, std::__va_list)+336)</span><br><span class="line">#10  pc 000635dd  /system/lib/libdvm.so (dvmCallMethod(Thread*, Method const*, Object*, JValue*, ...)+20)</span><br><span class="line">#11  pc 000582bb  /system/lib/libdvm.so</span><br><span class="line">#12  pc 0000d2c0  /system/lib/libc.so (__thread_entry+72)</span><br><span class="line">#13  pc 0000d458  /system/lib/libc.so (pthread_create+240)</span><br><span class="line">at libcore.io.Posix.fsync(Native Method)</span><br><span class="line">at libcore.io.BlockGuardOs.fsync(BlockGuardOs.java:97)</span><br><span class="line">at java.io.FileDescriptor.sync(FileDescriptor.java:74)</span><br><span class="line">at android.os.FileUtils.sync(FileUtils.java:154)</span><br><span class="line">at android.app.SharedPreferencesImpl.writeToFile(SharedPreferencesImpl.java:597)</span><br><span class="line">at android.app.SharedPreferencesImpl.access$800(SharedPreferencesImpl.java:52)</span><br><span class="line">at android.app.SharedPreferencesImpl$2.run(SharedPreferencesImpl.java:511)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1112)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:587)</span><br><span class="line">at java.lang.Thread.run(Thread.java:841)</span><br></pre></td></tr></table></figure>
<p>Here is a detailed explanation of how the codes work in Android N (codes is taken from <a href="https://android.googlesource.com/platform/frameworks/base/+/nougat-mr1-release/core/java/android/app/SharedPreferencesImpl.java" target="_blank" rel="noopener">https://android.googlesource.com/platform/frameworks/base/+/nougat-mr1-release/core/java/android/app/SharedPreferencesImpl.java</a>):</p>
<p>Here is how <code>apply()</code> works:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: SharedPreferencesImpl.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This triggers save all changes in this editor to the in memory key-value map.</span></span><br><span class="line">    <span class="comment">// The return value is a MemoryCommitResult instance that can be used to listen for</span></span><br><span class="line">    <span class="comment">// when is the disk write done.</span></span><br><span class="line">    <span class="keyword">final</span> MemoryCommitResult mcr = commitToMemory();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// This is a Runnable that waits for the above mcr being written to disk.</span></span><br><span class="line">    <span class="keyword">final</span> Runnable awaitCommit = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mcr.writtenToDiskLatch.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The above Runnable is added to the QueuedWork.</span></span><br><span class="line">    <span class="comment">// QueueWork is a static queue that stores all apply infos.</span></span><br><span class="line">    QueuedWork.add(awaitCommit);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A Runnable that waits for awaitCommit to be done and then remove it from QueuedWork.</span></span><br><span class="line">    Runnable postWriteRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                awaitCommit.run();</span><br><span class="line">                QueuedWork.remove(awaitCommit);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is the actual places that schedule to write the memory commit result to disk.</span></span><br><span class="line">    <span class="comment">// It's also provided with the postWriteRunnable which will remove the awaitCommit</span></span><br><span class="line">    <span class="comment">// Runnable from QueuedWork when the disk write is done.</span></span><br><span class="line">    SharedPreferencesImpl.<span class="keyword">this</span>.enqueueDiskWrite(mcr, postWriteRunnable);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Okay to notify the listeners before it's hit disk</span></span><br><span class="line">    <span class="comment">// because the listeners should always get the same</span></span><br><span class="line">    <span class="comment">// SharedPreferences instance back, which has the</span></span><br><span class="line">    <span class="comment">// changes reflected in memory.</span></span><br><span class="line">    notifyListeners(mcr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>So what is does is pretty simple: It calls <code>commitToMemory()</code> to commit the changes into memory and uses <code>enqueueDiskWrite()</code> to enqueue the memory changes for a disk write. It also offers <code>QueuedWork</code> a Runnable that can listen for when the disk wrtie is done, and uses a post write Runnable to remove it from QueueWork.</p>
<p>For comparasion we can also take a look at <code>commit()</code> method:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	MemoryCommitResult mcr = commitToMemory();</span><br><span class="line">	SharedPreferencesImpl.<span class="keyword">this</span>.enqueueDiskWrite(</span><br><span class="line">		mcr, <span class="keyword">null</span> <span class="comment">/* sync write on this thread okay */</span>);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		mcr.writtenToDiskLatch.await();</span><br><span class="line">	&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	notifyListeners(mcr);</span><br><span class="line">	<span class="keyword">return</span> mcr.writeToDiskResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>All it does is commit to memory, write to disk and then wait for the write to finish.</p>
<p>Then how does ANR happen? If you take a look at the stack trace at the very beginning it’s actually happening at <code>QueuedWork.waitToFinish()</code>. Here is the code for that, including the comments in the original file:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: QueuedWork.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Finishes or waits for async operations to complete.</span></span><br><span class="line"><span class="comment"> * (e.g. SharedPreferences$Editor#startCommit writes)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Is called from the Activity base class's onPause(), after</span></span><br><span class="line"><span class="comment"> * BroadcastReceiver's onReceive, after Service command handling,</span></span><br><span class="line"><span class="comment"> * etc.  (so async work is never lost)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">waitToFinish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Runnable toFinish;</span><br><span class="line">	<span class="keyword">while</span> ((toFinish = sPendingWorkFinishers.poll()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">		toFinish.run();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>and also</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: ActivityThread.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleStopActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> show, <span class="keyword">int</span> configChanges, <span class="keyword">int</span> seq)</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Make sure any pending writes are now committed.</span></span><br><span class="line">	<span class="keyword">if</span> (!r.isPreHoneycomb()) &#123;</span><br><span class="line">		QueuedWork.waitToFinish();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The comments is saying that at some places in the application lifecycles, the application will call this method and wait for all runnables in <code>sPendingWorkFinishers</code> to finish. <code>sPendingWorkFinishers</code> contains all <code>awaitCommit</code> runnables that is added by each <code>apply()</code> method, and that means at those checkpoints like <code>Activity.onPause()</code> the app will block on main thread for all async shared preferences write to finish. If by any reasons the disk operation you have takes more than 5 seconds, ANR is triggered.</p>
<p>What not clear to me is that why this kind of synchronization can make sure “async work is never lost”. The async writing is always happening on a background thread with or without the blocking of main thread. If the process is getting killed, then the write can’t be done anyway. Also if the system don’t trigger a ANR at those points, the background tasks will likely got more time to finish.</p>
<h2 id="How-to-Fix"><a href="#How-to-Fix" class="headerlink" title="How to Fix"></a>How to Fix</h2><ol>
<li><p>Write better code. The default implementation of shared preference will read and write the whole xml file every time, so one should avoid storing large data like json or serialized data in the shared preferences. </p>
</li>
<li><p>If the app scale is so large and that doesn’t work, there is still ways to don’t let main thread blocked by async writing and avoid this ANR. The possible solution is to use a background <code>commit()</code> instead of <code>apply()</code>, or modify the <code>QueuedWork</code> code to let the wait method return immediately. Note that these approaches somehow violates the original design of shared preference implementation, and should be used in cautions.</p>
</li>
<li><p>Don’t use the default implementation of shared preferences. Come up with your implementation or use an alternative. SQLite is not meant for that, but could be an option. There should be other alternatives you can find by a quick search. Even copy and modify the shared preferences code from Android might work, but you need to maintain that code by yourself since then:)</p>
</li>
</ol>
<h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h2><p>Note that this issue is fixed in Android O.</p>
<blockquote>
<p>TODO: Add references to the code changes.</p>
</blockquote>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>CATEGORIES</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">1</span></li></ul></div></div><div class="widget"><div class="tagcloud"><h4>TAGS</h4><a href="/tags/ANR/" style="font-size: 10px;">ANR</a> <a href="/tags/Android/" style="font-size: 10px;">Android</a></div></div><div class="widget"><div class="recent"><h4>RECENT POSTS</h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/12/17/anr-in-shared-preferences/">ANR in SharedPreferences</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/17/hello-world/">Hello World</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">Search</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2018/12/17/hello-world/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'zcgu';
var disqus_identifier = '2018/12/17/anr-in-shared-preferences/';
var disqus_title = 'ANR in SharedPreferences';
var disqus_url = 'http://zcgu.github.io/2018/12/17/anr-in-shared-preferences/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//zcgu.disqus.com/count.js" async> </script><div class="copyright"><p>© 2018 <a target="_blank">Zhicheng Gu</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="http://apps.bdimg.com/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="/scripts/hit-kounter-lc-0.2.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script></body></html>